<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت - کافه فرنود</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-content">
                <h1 class="header-title">
                    <span class="cafe-icon">☕</span>
                    پنل مدیریت کافه فرنود
                </h1>
                <div class="header-actions">
                    <button class="btn btn-secondary">خروج</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Products List Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2 class="section-title">لیست محصولات فعلی</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary">تازه‌سازی</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>نام محصول</th>
                                <th>قیمت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- محصولات به صورت داینامیک اضافه می‌شوند -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Management Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2 class="section-title">کاربران</h2>
                </div>

                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>آیدی</th>
                                <th>نام کاربری</th>
                                <th>ایمیل</th>
                                <th>رمز (مخفی)</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- کاربران به صورت داینامیک اضافه می‌شوند -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Add New Product Section -->
            <section class="content-section">
                <div class="section-header">
                    <h2 class="section-title">افزودن محصول جدید</h2>
                </div>
                
                <form class="admin-form" action="#" method="POST">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="product-name" class="form-label">نام محصول</label>
                            <input 
                                type="text" 
                                id="product-name" 
                                name="product-name" 
                                class="form-input" 
                                placeholder="نام محصول را وارد کنید"
                                required
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="product-price" class="form-label">قیمت (تومان)</label>
                            <input 
                                type="text" 
                                id="product-price" 
                                name="product-price" 
                                class="form-input" 
                                placeholder="قیمت را وارد کنید"
                                inputmode="numeric"
                                required
                            >
                        </div>
                        
                        <div class="form-group form-group-full">
                            <label for="product-description" class="form-label">توضیحات کوتاه</label>
                            <textarea 
                                id="product-description" 
                                name="product-description" 
                                class="form-textarea" 
                                placeholder="توضیحات محصول را وارد کنید"
                                rows="4"
                                required
                            ></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-category" class="form-label">دسته‌بندی</label>
                            <select id="product-category" name="product-category" class="form-select" required>
                                <option value="">دسته‌بندی را انتخاب کنید</option>
                                <option value="coffee">قهوه</option>
                                <option value="tea">چای</option>
                                <option value="dessert">دسر</option>
                                <option value="snack">تنقلات</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-status" class="form-label">وضعیت</label>
                            <select id="product-status" name="product-status" class="form-select" required>
                                <option value="active">فعال</option>
                                <option value="inactive">غیرفعال</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">افزودن محصول</button>
                        <button type="reset" class="btn btn-secondary">پاک کردن</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script>
        // تابع برای تبدیل عدد به فارسی
        function toPersianNumber(num) {
            if (typeof num !== 'string' && typeof num !== 'number') return num;
            return num.toString().replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        }

        // تابع برای تبدیل ارقام فارسی به انگلیسی
        function persianToEnglishDigits(str) {
            if (!str) return '';
            return str.replace(/[۰-۹]/g, d => '0123456789'['۰۱۲۳۴۵۶۷۸۹'.indexOf(d)]);
        }

        // تابع برای افزودن جداکننده هزارگان و تبدیل به فارسی برای نمایش
        function formatPriceForDisplay(value) {
            if (value === null || value === undefined) return '';
            // پاکسازی: نگه داشتن فقط ارقام (فارسی یا لاتین)
            let cleaned = String(value).replace(/[^0-9۰-۹]/g, '');
            // تبدیل فارسی به انگلیسی برای پردازش
            const eng = persianToEnglishDigits(cleaned);
            if (!eng) return '';
            // فرمت با کاما برای هزارگان (انگلیسی)
            const withCommas = eng.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            // تبدیل ارقام به فارسی و بازگرداندن
            return toPersianNumber(withCommas);
        }

        // پاکسازی مقدار نمایش داده شده برای ارسال به سرور: تبدیل به ارقام انگلیسی بدون جداکننده
        function cleanPriceForSubmit(displayValue) {
            if (!displayValue) return '';
            // حذف "تومان" و فاصله
            let v = String(displayValue).replace(/تومان/g, '').replace(/\s/g, '');
            // تبدیل ارقام فارسی به انگلیسی
            v = persianToEnglishDigits(v);
            // حذف کاما
            v = v.replace(/,/g, '');
            return v;
        }

        // تابع برای بارگذاری محصولات از API
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:5000/api/products');
                if (!response.ok) {
                    throw new Error('خطا در دریافت محصولات');
                }
                const products = await response.json();
                const tableBody = document.getElementById('products-table-body');
                tableBody.innerHTML = '';

                products.forEach(product => {
                    const cleanPrice = formatPriceForDisplay(product.price);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${cleanPrice} تومان</td>
                        <td class="action-buttons">
                            <button class="btn btn-edit" data-id="${product.id}">ویرایش</button>
                            <button class="btn btn-delete" data-id="${product.id}">حذف</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // فعال‌سازی دکمه‌های ویرایش و حذف
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        // پیدا کردن محصول از لیست
                        const product = products.find(p => String(p.id) === String(id));
                        if (!product) {
                            alert('محصول یافت نشد.');
                            return;
                        }
                        // پر کردن فرم با اطلاعات محصول
                        document.getElementById('product-name').value = product.name;
                        // مقدار قیمت را به فرمت نمایش تبدیل کنیم
                        document.getElementById('product-price').value = formatPriceForDisplay(product.price) + ' تومان';
                        document.getElementById('product-description').value = product.description;
                        // اضافه کردن یک hidden field برای نگهداری id و تغییر دکمه افزودن به بروزرسانی
                        document.querySelector('.admin-form').setAttribute('data-edit-id', id);
                        document.querySelector('.admin-form .btn-success').textContent = 'بروزرسانی محصول';
                    });
                });

                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (!confirm('آیا مطمئن هستید که می‌خواهید این محصول را حذف کنید؟')) return;
                        const id = this.getAttribute('data-id');
                        try {
                            const res = await fetch(`http://localhost:5000/api/products/${id}`, {
                                method: 'DELETE'
                            });
                            let resultText = await res.text();
                            let result;
                            try { result = JSON.parse(resultText); } catch { result = { message: resultText || '' }; }
                            if (res.ok) {
                                alert('محصول با موفقیت حذف شد!');
                                loadProducts();
                            } else {
                                alert(result.message || `خطا در حذف محصول (status ${res.status})`);
                            }
                        } catch (err) {
                            alert('خطا در ارتباط با سرور');
                        }
                    });
                });
            } catch (error) {
                console.error('خطا در بارگذاری محصولات:', error);
                alert('خطا در بارگذاری محصولات. لطفاً دوباره تلاش کنید.');
            }
        }

        // هندل کردن ارسال فرم افزودن/ویرایش محصول
        document.querySelector('.admin-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('product-name').value;
            const priceRaw = document.getElementById('product-price').value;
            const price = cleanPriceForSubmit(priceRaw);
            const description = document.getElementById('product-description').value;

            const editId = this.getAttribute('data-edit-id');
            const isEdit = !!editId;

            try {
                let res;
                if (isEdit) {
                    // ارسال PUT برای بروزرسانی
                    res = await fetch(`http://localhost:5000/api/products/${editId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name, price, description })
                    });
                } else {
                    res = await fetch('http://localhost:5000/api/products', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name, price, description })
                    });
                }

                const resultText = await res.text();
                let result;
                try { result = JSON.parse(resultText); } catch { result = { message: resultText || '' }; }
                if (res.ok) {
                    alert(isEdit ? 'محصول با موفقیت به‌روز شد!' : 'محصول با موفقیت اضافه شد!');
                    this.reset();
                    this.removeAttribute('data-edit-id');
                    document.querySelector('.admin-form .btn-success').textContent = 'افزودن محصول';
                    loadProducts(); // لیست را به‌روز کن
                } else {
                    alert(result.message || `خطا در عملیات (status ${res.status})`);
                }
            } catch (err) {
                alert('خطا در ارتباط با سرور');
            }
        });

        // هندل کردن دکمه ریست برای پاک کردن حالت ویرایش
        document.querySelector('.admin-form').addEventListener('reset', function() {
            this.removeAttribute('data-edit-id');
            document.querySelector('.admin-form .btn-success').textContent = 'افزودن محصول';
        });

        // فرمت زنده ورودی قیمت: تبدیل لاتین->فارسی، افزودن تومان در انتها
        const priceInput = document.getElementById('product-price');
        priceInput.addEventListener('input', function(e) {
            const caret = this.selectionStart;
            let val = this.value;
            // حذف "تومان" برای پردازش
            val = val.replace(/تومان/g, '').trim();
            // حذف کاراکترهای غیر عددی به جز کاما و نقطه
            // اجازه کاما برای جداکننده هزارگان
            val = val.replace(/[^0-9,۰-۹]/g, '');
            // تبدیل فارسی به انگلیسی، سپس فرمت هزارگان، سپس به فارسی
            const eng = persianToEnglishDigits(val);
            const withCommas = eng.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const displayed = toPersianNumber(withCommas);
            this.value = displayed ? (displayed + ' تومان') : '';
            // سعی برای حفظ caret نزدیک موقعیت قبلی
            try { this.setSelectionRange(Math.max(0, Math.min(this.value.length - 6, caret)), Math.max(0, Math.min(this.value.length - 6, caret))); } catch (err) {}
        });

        // بارگذاری محصولات و کاربران به محض بارگذاری صفحه
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadUsers();
        });

        // بارگذاری لیست کاربران
        async function loadUsers() {
            try {
                const res = await fetch('http://localhost:5000/api/users');
                if (!res.ok) throw new Error('خطا در دریافت کاربران');
                const users = await res.json();
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    // show whether password exists but mask it
                    const pwPresent = u.password_hash ? '●●●●●●' : '(ندارد)';
                    tr.innerHTML = `
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${pwPresent}</td>
                        <td class="action-buttons">
                            <button class="btn btn-reset-pw" data-id="${u.id}">تغییر رمز</button>
                            <button class="btn btn-delete-user" data-id="${u.id}">حذف</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                document.querySelectorAll('.btn-delete-user').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (!confirm('آیا برای حذف این کاربر مطمئن هستید؟')) return;
                        const id = this.getAttribute('data-id');
                        try {
                            const r = await fetch(`http://localhost:5000/api/users/${id}`, { method: 'DELETE' });
                            if (r.ok) {
                                alert('کاربر حذف شد');
                                loadUsers();
                            } else {
                                let text = await r.text();
                                let json;
                                try { json = JSON.parse(text); } catch { json = { message: text } }
                                alert(json.message || 'خطا در حذف کاربر');
                            }
                        } catch (err) {
                            alert('خطا در ارتباط با سرور');
                        }
                    });
                });
                // reset password buttons
                document.querySelectorAll('.btn-reset-pw').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        const newpw = prompt('رمز جدید را وارد کنید:');
                        if (!newpw) return alert('رمز جدید وارد نشد.');
                        try {
                            const r = await fetch(`http://localhost:5000/api/users/${id}/reset`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ password: newpw })
                            });
                            if (r.ok) {
                                alert('رمز با موفقیت بروزرسانی شد');
                                loadUsers();
                            } else {
                                let text = await r.text();
                                let json;
                                try { json = JSON.parse(text); } catch { json = { message: text } }
                                alert(json.message || 'خطا در بروزرسانی رمز');
                            }
                        } catch (err) {
                            alert('خطا در ارتباط با سرور');
                        }
                    });
                });
            } catch (err) {
                console.error('loadUsers error', err);
            }
        }
    </script>
</body>
</html> 